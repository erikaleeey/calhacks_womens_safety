{"version":3,"names":["_EventEmitter","require","_index","_reactNativeQuickBase","_LKNativeModule","_interopRequireDefault","_logger","e","__esModule","default","_defineProperty","r","t","_toPropertyKey","Object","defineProperty","value","enumerable","configurable","writable","i","_toPrimitive","Symbol","toPrimitive","call","TypeError","String","Number","MediaRecorder","EventTarget","constructor","stream","undefined","registerListener","audioTracks","getAudioTracks","length","mediaStreamTrack","peerConnectionId","_peerConnectionId","mediaStreamTrackId","id","_reactTag","LiveKitModule","createAudioSinkListener","addListener","event","state","str","data","_parts","push","unregisterListener","log","error","deleteAudioSinkListener","pause","dispatchEvent","Event","resume","start","stop","dispatchData","requestData","combinedStr","reduce","sum","cur","toByteArray","BlobEvent","byteArray","exports","type","eventInitDict","proto","prototype","defineEventAttribute"],"sources":["MediaRecorder.ts"],"sourcesContent":["import type { MediaStream } from '@livekit/react-native-webrtc';\nimport { addListener } from '../events/EventEmitter';\nimport {\n  EventTarget,\n  Event,\n  defineEventAttribute,\n} from 'event-target-shim/index';\nimport { toByteArray } from 'react-native-quick-base64';\nimport LiveKitModule from '../LKNativeModule';\nimport { log } from '../logger';\n\n// typeof MediaRecorder\n// const Tester = (stream: MediaStream) => {\n//   return new AudioRecorder(stream) satisfies MediaRecorder;\n// };\n\ntype MediaRecorderState = 'inactive' | 'recording' | 'paused';\ntype MediaRecorderEventMap = {\n  dataavailable: BlobEvent<'dataavailable'>;\n  error: Event<'error'>;\n  pause: Event<'pause'>;\n  resume: Event<'resume'>;\n  start: Event<'start'>;\n  stop: Event<'stop'>;\n};\n\n/**\n * A MediaRecord implementation only meant for recording audio streams.\n *\n * @private\n */\nexport class MediaRecorder extends EventTarget<MediaRecorderEventMap> {\n  mimeType: String = 'audio/pcm';\n  audioBitsPerSecond: number = 0; // TODO?\n  state: MediaRecorderState = 'inactive';\n  stream: MediaStream;\n  videoBitsPerSecond: number = 0; // TODO?\n  audioBitrateMode = 'constant';\n\n  _reactTag: string | undefined = undefined;\n  _parts: string[] = [];\n  constructor(stream: MediaStream) {\n    super();\n    this.stream = stream;\n  }\n\n  registerListener() {\n    let audioTracks = this.stream.getAudioTracks();\n    if (audioTracks.length !== 1) {\n      return;\n    }\n    const mediaStreamTrack = audioTracks[0];\n    const peerConnectionId = mediaStreamTrack._peerConnectionId ?? -1;\n    const mediaStreamTrackId = mediaStreamTrack?.id;\n    this._reactTag = LiveKitModule.createAudioSinkListener(\n      peerConnectionId,\n      mediaStreamTrackId\n    );\n    addListener(this, 'LK_AUDIO_DATA', (event: any) => {\n      if (\n        this._reactTag &&\n        event.id === this._reactTag &&\n        this.state === 'recording'\n      ) {\n        let str = event.data as string;\n        this._parts.push(str);\n      }\n    });\n  }\n\n  unregisterListener() {\n    if (this._reactTag) {\n      let audioTracks = this.stream.getAudioTracks();\n      if (audioTracks.length !== 1) {\n        log.error(\"couldn't find any audio tracks to record from!\");\n        return;\n      }\n      const mediaStreamTrack = audioTracks[0];\n      const peerConnectionId = mediaStreamTrack._peerConnectionId ?? -1;\n      const mediaStreamTrackId = mediaStreamTrack?.id;\n\n      LiveKitModule.deleteAudioSinkListener(\n        this._reactTag,\n        peerConnectionId,\n        mediaStreamTrackId\n      );\n    }\n  }\n\n  pause() {\n    this.state = 'paused';\n    this.dispatchEvent(new Event('pause'));\n  }\n\n  resume() {\n    this.state = 'recording';\n    this.dispatchEvent(new Event('resume'));\n  }\n\n  start() {\n    this.registerListener();\n    this.state = 'recording';\n    this.dispatchEvent(new Event('start'));\n  }\n\n  stop() {\n    // dispatch data must come before stopping.\n    this.dispatchData();\n\n    this.unregisterListener();\n    this.state = 'inactive';\n    this.dispatchEvent(new Event('stop'));\n  }\n\n  requestData() {\n    this.dispatchData();\n  }\n  dispatchData() {\n    let combinedStr = this._parts.reduce((sum, cur) => sum + cur, '');\n    let data = toByteArray(combinedStr);\n    this._parts = [];\n    this.dispatchEvent(\n      new BlobEvent('dataavailable', { data: { byteArray: data } })\n    );\n  }\n}\n\n/**\n * @eventClass\n * This event is fired whenever the Track is changed in PeerConnection.\n * @param {TRACK_EVENTS} type - The type of event.\n * @param {IRTCTrackEventInitDict} eventInitDict - The event init properties.\n * @see {@link https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/track_event MDN} for details.\n */\nclass BlobEvent<TEventType extends string> extends Event<TEventType> {\n  /** @eventProperty */\n  readonly data: { byteArray: Uint8Array };\n\n  constructor(\n    type: TEventType,\n    eventInitDict: { data: { byteArray: Uint8Array } } & Event.EventInit\n  ) {\n    super(type, eventInitDict);\n    this.data = eventInitDict.data;\n  }\n}\n\n/**\n * Define the `onxxx` event handlers.\n */\nconst proto = MediaRecorder.prototype;\n\ndefineEventAttribute(proto, 'dataavailable');\ndefineEventAttribute(proto, 'error');\ndefineEventAttribute(proto, 'pause');\ndefineEventAttribute(proto, 'resume');\ndefineEventAttribute(proto, 'start');\ndefineEventAttribute(proto, 'stop');\n"],"mappings":"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","ignoreList":[]}